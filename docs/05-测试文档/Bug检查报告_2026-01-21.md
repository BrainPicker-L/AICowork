---
title: Bug æ£€æŸ¥æŠ¥å‘Š
author: Alan
copyright: AGCPA v3.0
created: 2026-01-21
updated: 2026-01-21
email: None
category: æµ‹è¯•æ–‡æ¡£
version: 1.0.0
---

# Bug æ£€æŸ¥æŠ¥å‘Š

**æ£€æŸ¥æ—¥æœŸ**: 2026-01-21
**æ£€æŸ¥èŒƒå›´**: è®¾ç½®é¡µé¢åŠŸèƒ½å®ç°
**æ£€æŸ¥æ–¹å¼**: é™æ€ä»£ç åˆ†æ

---

## ä¸€ã€Bug ç»Ÿè®¡æ€»è§ˆ

| ä¸¥é‡ç¨‹åº¦ | æ•°é‡ | è¯´æ˜ |
|----------|------|------|
| **CRITICAL** | 1 | è·¯å¾„éå†å®‰å…¨æ¼æ´ |
| **HIGH** | 8 | å¹¶å‘ç«äº‰ã€é”™è¯¯å¤„ç†ã€åŒæ­¥I/Oã€å†…å­˜æ³„æ¼ |
| **MEDIUM** | 13 | JSONè§£æã€éªŒè¯ä¸å®Œæ•´ã€ä»£ç è§„èŒƒ |
| **LOW** | 7 | ç±»å‹æ–­è¨€ã€å›½é™…åŒ– |
| **æ€»è®¡** | **29** | - |

---

## äºŒã€CRITICAL çº§åˆ« Bug

### Bug #1: è·¯å¾„éå†å®‰å…¨æ¼æ´ ğŸ”´

**æ–‡ä»¶**: `src/electron/libs/skills-store.ts`
**ä½ç½®**: ç¬¬ 33-34 è¡Œï¼Œç¬¬ 179-201 è¡Œ
**ä¸¥é‡ç¨‹åº¦**: CRITICAL

**é—®é¢˜æè¿°**:
```typescript
function getSkillFilePath(skillName: string): string {
  return join(getSkillsDir(), skillName, 'SKILL.md');
}
```

ç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥ä½œä¸ºè·¯å¾„ï¼Œæ²¡æœ‰éªŒè¯ã€‚æ”»å‡»è€…å¯ä½¿ç”¨ `../../etc/passwd` è®¿é—®ç³»ç»Ÿæ–‡ä»¶ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
import { normalize, basename } from 'path';

function getSkillFilePath(skillName: string): string {
  // éªŒè¯å¹¶æ¸…ç†æŠ€èƒ½åç§°
  const cleanName = basename(normalize(skillName));
  if (cleanName !== skillName || cleanName.includes('/') || cleanName.includes('\\')) {
    throw new Error('Invalid skill name');
  }
  // åªå…è®¸å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦ã€ä¸‹åˆ’çº¿
  if (!/^[a-zA-Z0-9_-]+$/.test(cleanName)) {
    throw new Error('Skill name must contain only letters, numbers, hyphens, and underscores');
  }
  return join(getSkillsDir(), cleanName, 'SKILL.md');
}
```

---

## ä¸‰ã€HIGH çº§åˆ« Bug

### Bug #2: å¹¶å‘å†™å…¥ç«äº‰æ¡ä»¶

**æ–‡ä»¶**: `src/electron/libs/skills-store.ts`
**ä½ç½®**: ç¬¬ 138-144 è¡Œ
**ä¸¥é‡ç¨‹åº¦**: HIGH

**é—®é¢˜æè¿°**:
æ£€æŸ¥æ–‡ä»¶å­˜åœ¨å’Œåˆ›å»ºæ–‡ä»¶ä¹‹é—´å­˜åœ¨ç«äº‰æ¡ä»¶ï¼Œå¤šä¸ªå¹¶å‘è¯·æ±‚å¯èƒ½åŒæ—¶é€šè¿‡æ£€æŸ¥ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
export async function createSkill(config: SkillConfig): Promise<{ success: boolean; error?: string }> {
  // ... éªŒè¯é€»è¾‘ ...

  try {
    const skillPath = getSkillFilePath(config.name);
    const skillDir = dirname(skillPath);

    // ä½¿ç”¨ mkdir çš„ recursive é€‰é¡¹å’Œæ–‡ä»¶é”
    await fs.mkdir(skillDir, { recursive: true });

    // åŸå­æ€§å†™å…¥ï¼šå…ˆå†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œå†é‡å‘½å
    const tempPath = skillPath + '.tmp';
    await fs.writeFile(tempPath, content, 'utf-8');

    // å°è¯•é‡å‘½åï¼Œå¦‚æœæ–‡ä»¶å·²å­˜åœ¨ä¼šå¤±è´¥
    try {
      await fs.rename(tempPath, skillPath);
    } catch (renameError: any) {
      // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
      await fs.unlink(tempPath).catch(() => {});
      if (renameError.code === 'EEXIST') {
        return { success: false, error: 'æŠ€èƒ½å·²å­˜åœ¨' };
      }
      throw renameError;
    }

    return { success: true };
  } catch (error: any) {
    if (error.code === 'EEXIST') {
      return { success: false, error: 'æŠ€èƒ½å·²å­˜åœ¨' };
    }
    log.error('[SkillsStore] Failed to create skill', error);
    return { success: false, error: 'åˆ›å»ºæŠ€èƒ½å¤±è´¥' };
  }
}
```

### Bug #3: saveHooksConfig ç¼ºå°‘é”™è¯¯å¤„ç†

**æ–‡ä»¶**: `src/electron/libs/hooks-store.ts`
**ä½ç½®**: ç¬¬ 66-69 è¡Œ
**ä¸¥é‡ç¨‹åº¦**: HIGH

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
async function saveHooksConfig(config: HooksStore): Promise<void> {
  try {
    await fs.ensureDir(configDir);
    await fs.writeFile(configPath, JSON.stringify(config, null, 2), 'utf-8');
  } catch (error) {
    log.error('[HooksStore] Failed to save hooks config', error);
    throw new Error('Failed to save hooks configuration');
  }
}
```

### Bug #4: savePermissionsConfig ç¼ºå°‘é”™è¯¯å¤„ç†

**æ–‡ä»¶**: `src/electron/libs/permissions-store.ts`
**ä½ç½®**: ç¬¬ 65-68 è¡Œ
**ä¸¥é‡ç¨‹åº¦**: HIGH

**ä¿®å¤æ–¹æ¡ˆ**: åŒ Bug #3

### Bug #5: åŒæ­¥æ–‡ä»¶æ“ä½œé˜»å¡äº‹ä»¶å¾ªç¯

**æ–‡ä»¶**: `src/electron/libs/mcp-store.ts`
**ä½ç½®**: å…¨å±€
**ä¸¥é‡ç¨‹åº¦**: HIGH

**é—®é¢˜æè¿°**: æ‰€æœ‰æ–‡ä»¶æ“ä½œä½¿ç”¨åŒæ­¥ API (`readFileSync`, `writeFileSync`)

**ä¿®å¤æ–¹æ¡ˆ**: æ”¹ä¸ºå¼‚æ­¥ API
```typescript
import { readFile, writeFile } from 'fs/promises';

export async function getMcpServers(): Promise<Record<string, McpServerConfig>> {
  try {
    await fs.ensureDir(mcpDir);
    // ...
  }
}
```

### Bug #6-9: setTimeout å†…å­˜æ³„æ¼ (4å¤„)

**æ–‡ä»¶**:
- `src/ui/pages/SettingsPage/sections/SkillsSection.tsx` (ç¬¬ 76 è¡Œ)
- `src/ui/pages/SettingsPage/sections/HooksSection.tsx` (ç¬¬ 76 è¡Œ)
- `src/ui/pages/SettingsPage/sections/PermissionsSection.tsx` (ç¬¬ 82 è¡Œ)
- `src/ui/pages/SettingsPage/sections/OutputSection.tsx` (ç¬¬ 67 è¡Œ)
**ä¸¥é‡ç¨‹åº¦**: HIGH

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
const [success, setSuccess] = useState(false);

useEffect(() => {
  if (success) {
    const timer = setTimeout(() => setSuccess(false), 2000);
    return () => clearTimeout(timer);
  }
}, [success]);
```

---

## å››ã€MEDIUM çº§åˆ« Bug

### Bug #10: JSON è§£æé”™è¯¯å¤„ç†ä¸å®Œæ•´ (3å¤„)

**æ–‡ä»¶**:
- `src/electron/libs/hooks-store.ts` (ç¬¬ 45-46 è¡Œ)
- `src/electron/libs/permissions-store.ts` (ç¬¬ 43-46 è¡Œ)
- `src/electron/libs/output-store.ts` (ç¬¬ 51-54 è¡Œ)

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
async function loadHooksConfig(): Promise<HooksStore> {
  try {
    const content = await fs.readFile(configPath, 'utf-8');
    return JSON.parse(content);
  } catch (error: any) {
    if (error.code === 'ENOENT') {
      return { preToolUse: [], postToolUse: [] };
    }
    if (error instanceof SyntaxError) {
      log.error('[HooksStore] Invalid JSON in config file', error);
      return { preToolUse: [], postToolUse: [] };
    }
    throw error;
  }
}
```

### Bug #11: æŠ€èƒ½åç§°éªŒè¯ä¸å®Œæ•´

**æ–‡ä»¶**: `src/ui/pages/SettingsPage/sections/SkillsSection.tsx`
**ä½ç½®**: ç¬¬ 51-54 è¡Œ
**ä¸¥é‡ç¨‹åº¦**: MEDIUM

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
const nameRegex = /^[a-zA-Z0-9_-]{1,64}$/;
if (!nameRegex.test(skillName.trim())) {
  setError('æŠ€èƒ½åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦å’Œä¸‹åˆ’çº¿ï¼Œé•¿åº¦1-64å­—ç¬¦');
  return;
}
```

### Bug #12: é’©å­å”¯ä¸€æ€§æœªéªŒè¯

**æ–‡ä»¶**: `src/ui/pages/SettingsPage/sections/HooksSection.tsx`
**ä½ç½®**: ç¬¬ 50-91 è¡Œ

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
const hookExists = hooks[hookType].some(h => h.hook === hookName.trim());
if (hookExists) {
  setError('å·²å­˜åœ¨åŒåé’©å­');
  return;
}
```

### Bug #13: æƒé™è§„åˆ™å”¯ä¸€æ€§æœªéªŒè¯

**æ–‡ä»¶**: `src/ui/pages/SettingsPage/sections/PermissionsSection.tsx`
**ä½ç½®**: ç¬¬ 64-97 è¡Œ

**ä¿®å¤æ–¹æ¡ˆ**: åŒ Bug #12

### Bug #14: EventPayloadMapping ç¼ºå°‘ç±»å‹å®šä¹‰

**æ–‡ä»¶**: `src/electron/util.ts`
**ä¸¥é‡ç¨‹åº¦**: MEDIUM

**éœ€è¦æ·»åŠ çš„ç±»å‹å®šä¹‰**:
```typescript
export interface EventPayloadMapping {
    // ... ç°æœ‰å®šä¹‰ ...

    // Skills æ“ä½œ
    "get-skills-list": SkillConfig[];
    "create-skill": { success: boolean; error?: string };
    "delete-skill": { success: boolean; error?: string };
    "open-skills-directory": { success: boolean; error?: string };

    // Hooks æ“ä½œ
    "get-hooks-config": HooksStore;
    "save-hook": { success: boolean; error?: string };
    "delete-hook": { success: boolean; error?: string };

    // Permissions æ“ä½œ
    "get-permissions-config": PermissionsStore;
    "save-permission-rule": { success: boolean; error?: string };
    "delete-permission-rule": { success: boolean; error?: string };

    // Output æ“ä½œ
    "get-output-config": OutputConfig;
    "save-output-config": { success: boolean; error?: string };

    // Session Recovery æ“ä½œ
    "get-sessions-list": SessionInfo[];
    "get-session-history": SessionHistory | null;
    "recover-session": { success: boolean; error?: string; sessionId?: string };
    "delete-session": { success: boolean; error?: string };
}
```

### Bug #15: get-output-config é»˜è®¤å€¼ä¸å®Œæ•´

**æ–‡ä»¶**: `src/electron/main.ts`
**ä½ç½®**: ç¬¬ 519-527 è¡Œ

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
return {
    format: "markdown",
    theme: "default",
    codeHighlight: true,
    showLineNumbers: false,
    fontSize: "medium",
    wrapCode: false,
};
```

### Bug #16: useEffect ä¸­å®šä¹‰å‡½æ•°

**æ–‡ä»¶**: `src/ui/pages/SettingsPage/sections/OutputSection.tsx`
**ä½ç½®**: ç¬¬ 32-47 è¡Œ

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
const loadConfig = useCallback(async () => {
  setLoading(true);
  try {
    const currentConfig = await window.electron.getOutputConfig();
    setConfig(currentConfig);
  } catch (error) {
    console.error('Failed to load output config:', error);
    setError('åŠ è½½é…ç½®å¤±è´¥');
  } finally {
    setLoading(false);
  }
}, []);

useEffect(() => {
  loadConfig();
}, [loadConfig]);
```

---

## äº”ã€LOW çº§åˆ« Bug

### Bug #17-20: ç¡¬ç¼–ç ä¸­æ–‡å­—ç¬¦ä¸²

**æ–‡ä»¶**: `src/ui/pages/SettingsPage/sections/RecoverySection.tsx`
**ä½ç½®**: ç¬¬ 31-42 è¡Œï¼Œç¬¬ 57 è¡Œï¼Œç¬¬ 150 è¡Œ

**ä¿®å¤æ–¹æ¡ˆ**: ä½¿ç”¨ `t()` ç¿»è¯‘å‡½æ•°

### Bug #21: æ¢å¤æˆåŠŸåæ— ç”¨æˆ·åé¦ˆ

**æ–‡ä»¶**: `src/ui/pages/SettingsPage/sections/RecoverySection.tsx`
**ä½ç½®**: ç¬¬ 102-104 è¡Œ

**ä¿®å¤æ–¹æ¡ˆ**: æ·»åŠ æˆåŠŸæç¤ºæˆ–è‡ªåŠ¨è·³è½¬

### Bug #22-25: ç±»å‹æ–­è¨€ä¸å®‰å…¨

**æ–‡ä»¶**:
- `src/ui/pages/SettingsPage/sections/HooksSection.tsx` (ç¬¬ 143 è¡Œ)
- `src/ui/pages/SettingsPage/sections/PermissionsSection.tsx` (ç¬¬ 144 è¡Œ)
- `src/ui/pages/SettingsPage/sections/OutputSection.tsx` (å¤šå¤„)

**ä¿®å¤æ–¹æ¡ˆ**: ä½¿ç”¨ç±»å‹å®ˆå«è€Œé `as` æ–­è¨€

---

## å…­ã€ä¿®å¤ä¼˜å…ˆçº§

### P0 - ç«‹å³ä¿®å¤ (å®‰å…¨/åŠŸèƒ½)

| Bug | é—®é¢˜æè¿° | é¢„è®¡æ—¶é—´ |
|-----|----------|----------|
| #1 | è·¯å¾„éå†æ¼æ´ | 15 åˆ†é’Ÿ |
| #2 | å¹¶å‘ç«äº‰ | 30 åˆ†é’Ÿ |
| #11 | æŠ€èƒ½åç§°éªŒè¯ | 10 åˆ†é’Ÿ |
| #15 | output-config é»˜è®¤å€¼ | 5 åˆ†é’Ÿ |

**æ€»è®¡**: ~1 å°æ—¶

### P1 - é«˜ä¼˜å…ˆçº§ (ç¨³å®šæ€§)

| Bug | é—®é¢˜æè¿° | é¢„è®¡æ—¶é—´ |
|-----|----------|----------|
| #3 | saveHooksConfig é”™è¯¯å¤„ç† | 10 åˆ†é’Ÿ |
| #4 | savePermissionsConfig é”™è¯¯å¤„ç† | 10 åˆ†é’Ÿ |
| #5 | MCP å¼‚æ­¥æ”¹é€  | 30 åˆ†é’Ÿ |
| #6-9 | setTimeout å†…å­˜æ³„æ¼ (4å¤„) | 20 åˆ†é’Ÿ |
| #10 | JSON è§£æé”™è¯¯å¤„ç† (3å¤„) | 15 åˆ†é’Ÿ |
| #12 | é’©å­å”¯ä¸€æ€§éªŒè¯ | 10 åˆ†é’Ÿ |
| #13 | æƒé™è§„åˆ™å”¯ä¸€æ€§éªŒè¯ | 10 åˆ†é’Ÿ |
| #14 | EventPayloadMapping ç±»å‹ | 20 åˆ†é’Ÿ |
| #16 | useEffect å‡½æ•°å®šä¹‰ | 15 åˆ†é’Ÿ |

**æ€»è®¡**: ~2.5 å°æ—¶

### P2 - ä¸­ä¼˜å…ˆçº§ (ä»£ç è´¨é‡)

| Bug | é—®é¢˜æè¿° | é¢„è®¡æ—¶é—´ |
|-----|----------|----------|
| #17-20 | å›½é™…åŒ–ç¿»è¯‘ | 30 åˆ†é’Ÿ |
| #21 | æ¢å¤æˆåŠŸåé¦ˆ | 15 åˆ†é’Ÿ |
| #22-25 | ç±»å‹æ–­è¨€ä¼˜åŒ– | 30 åˆ†é’Ÿ |

**æ€»è®¡**: ~1.25 å°æ—¶

### æ€»ä¿®å¤æ—¶é—´ä¼°ç®—

| ä¼˜å…ˆçº§ | æ—¶é—´ |
|--------|------|
| P0 | 1 å°æ—¶ |
| P1 | 2.5 å°æ—¶ |
| P2 | 1.25 å°æ—¶ |
| **æ€»è®¡** | **~4.75 å°æ—¶** |

---

## ä¸ƒã€ä¿®å¤æ£€æŸ¥æ¸…å•

### åç«¯ä¿®å¤

- [ ] Bug #1: skills-store.ts è·¯å¾„éªŒè¯
- [ ] Bug #2: skills-store.ts å¹¶å‘ç«äº‰
- [ ] Bug #3: hooks-store.ts é”™è¯¯å¤„ç†
- [ ] Bug #4: permissions-store.ts é”™è¯¯å¤„ç†
- [ ] Bug #5: mcp-store.ts å¼‚æ­¥æ”¹é€ 
- [ ] Bug #10: JSON è§£æé”™è¯¯å¤„ç† (3 æ–‡ä»¶)
- [ ] Bug #14: util.ts EventPayloadMapping
- [ ] Bug #15: main.ts output-config é»˜è®¤å€¼

### å‰ç«¯ä¿®å¤

- [ ] Bug #6: SkillsSection setTimeout
- [ ] Bug #7: HooksSection setTimeout
- [ ] Bug #8: PermissionsSection setTimeout
- [ ] Bug #9: OutputSection setTimeout
- [ ] Bug #11: SkillsSection åç§°éªŒè¯
- [ ] Bug #12: HooksSection å”¯ä¸€æ€§éªŒè¯
- [ ] Bug #13: PermissionsSection å”¯ä¸€æ€§éªŒè¯
- [ ] Bug #16: OutputSection useEffect
- [ ] Bug #17-20: RecoverySection å›½é™…åŒ–
- [ ] Bug #21: RecoverySection æˆåŠŸåé¦ˆ
- [ ] Bug #22-25: ç±»å‹æ–­è¨€ä¼˜åŒ–

---

## å…«ã€æµ‹è¯•å»ºè®®

ä¿®å¤å®Œæˆåï¼Œéœ€è¦è¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

### å®‰å…¨æµ‹è¯•
- [ ] è·¯å¾„éå†æ”»å‡»æµ‹è¯•
- [ ] æ¶æ„è¾“å…¥æµ‹è¯•

### åŠŸèƒ½æµ‹è¯•
- [ ] æŠ€èƒ½åˆ›å»º/åˆ é™¤
- [ ] é’©å­æ·»åŠ /åˆ é™¤
- [ ] æƒé™è§„åˆ™é…ç½®
- [ ] è¾“å‡ºæ ·å¼é…ç½®
- [ ] ä¼šè¯æ¢å¤

### å¹¶å‘æµ‹è¯•
- [ ] å¿«é€Ÿè¿ç»­åˆ›å»ºåŒåæŠ€èƒ½
- [ ] åŒæ—¶æ“ä½œå¤šä¸ªé…ç½®

### å†…å­˜æ³„æ¼æµ‹è¯•
- [ ] å¿«é€Ÿåˆ‡æ¢è®¾ç½®é¡µé¢
- [ ] é•¿æ—¶é—´è¿è¡Œæ£€æŸ¥

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-21
**ä¸‹æ¬¡å®¡æŸ¥å»ºè®®**: ä¿®å¤å®Œæˆåè¿›è¡Œå›å½’æµ‹è¯•
