# AICowork 架构设计文档

> **文档类型**: 技术文档
> **更新日期**: 2026-01-20
> **适用版本**: v0.1.0

---
> **@author**: Alan
> **@copyright**: Copyright © 2026
> **@created**: 2026-01-20
> **@Email**: alan@example.com
> **@license**: AGCPA v3.0
---

## 目录

- [概述](#概述)
- [技术栈](#技术栈)
- [架构设计](#架构设计)
- [数据流](#数据流)
- [安全设计](#安全设计)
- [扩展性设计](#扩展性设计)

---

## 概述

AICowork 是一个基于 Electron 的桌面 AI 编程助手应用，为 Claude Code 提供 GUI 界面。

### 核心目标

1. **可视化** - 将终端中的 Claude Code 转换为图形界面
2. **会话管理** - 支持多个会话的创建、恢复、删除
3. **实时交互** - 流式输出 AI 响应和工具调用
4. **安全可控** - 删除操作需要用户确认，工具权限控制

---

## 技术栈

### 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 19.2.3 | UI 框架 |
| Tailwind CSS | 4.1.18 | CSS 框架 |
| Zustand | 5.0.10 | 状态管理 |
| i18next | - | 国际化 |
| react-markdown | 10.1.0 | Markdown 渲染 |
| highlight.js | 11.11.1 | 代码高亮 |

### 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Electron | 39.2.7 | 桌面应用框架 |
| better-sqlite3 | 12.6.0 | 数据库 |
| Winston | 3.19.0 | 日志系统 |
| @anthropic-ai/claude-agent-sdk | 0.2.6 | Claude AI SDK |

---

## 架构设计

### 分层架构

```
┌─────────────────────────────────────────────────────────┐
│                    用户界面层 (UI)                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │ Sidebar  │  │ Prompt   │  │ Settings │             │
│  │          │  │ Input    │  │ Modal    │             │
│  └──────────┘  └──────────┘  └──────────┘             │
│                                                         │
│  React 19 + Tailwind CSS 4 + i18next                   │
└─────────────────────────────────────────────────────────┘
                          ↕ IPC
┌─────────────────────────────────────────────────────────┐
│                   预加载层 (Preload)                      │
│  contextBridge 安全 API 暴露                              │
└─────────────────────────────────────────────────────────┘
                          ↕ IPC
┌─────────────────────────────────────────────────────────┐
│                   主进程层 (Main)                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │  IPC     │  │ Session  │  │  Runner  │             │
│  │ Handlers │  │  Store   │  │   (AI)   │             │
│  └──────────┘  └──────────┘  └──────────┘             │
│                                                         │
│  Winston 日志 | 配置管理 | Claude SDK 集成              │
└─────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────┐
│                   数据层 (Data)                           │
│  ┌─────────────────────────────────────────────┐       │
│  │  better-sqlite3 (WAL 模式)                  │       │
│  │  - sessions 表                               │       │
│  │  - messages 表                               │       │
│  └─────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────┘
```

### 目录结构

```
src/
├── electron/              # 主进程
│   ├── main.ts           # 主入口
│   ├── preload.cts       # 预加载脚本
│   ├── ipc-handlers.ts   # IPC 事件处理
│   ├── logger.ts         # 日志系统
│   └── libs/             # 核心库
│       ├── claude-settings.ts  # Claude 配置
│       ├── config-store.ts     # 配置存储
│       ├── runner.ts           # AI 任务运行器
│       ├── session-store.ts    # 会话存储
│       └── util.ts             # 工具函数
│
└── ui/                    # 渲染进程
    ├── main.tsx           # React 入口
    ├── App.tsx            # 主应用组件
    ├── components/        # UI 组件
    │   ├── Sidebar.tsx
    │   ├── PromptInput.tsx
    │   ├── SettingsModal.tsx
    │   ├── EventCard.tsx
    │   └── ...
    ├── hooks/             # React Hooks
    │   ├── useIPC.ts
    │   └── useMessageWindow.ts
    ├── store/             # 状态管理
    │   └── useAppStore.ts
    ├── i18n/              # 国际化
    │   ├── locales/
    │   │   ├── en.ts
    │   │   └── zh.ts
    │   └── config.ts
    └── utils/             # 工具函数
        └── logger.ts      # 前端日志
```

---

## 数据流

### 会话创建流程

```
用户点击"新建任务"
        ↓
StartSessionModal 弹出
        ↓
用户输入 cwd 和 prompt
        ↓
sendEvent("session.start", { title, prompt, cwd })
        ↓
[主进程] ipc-handlers.handleClientEvent
        ↓
[主进程] sessions.createSession()
        ↓
[主进程] runner.runClaude()
        ↓
[主进程] SDK query({ prompt, permissionMode: "default" })
        ↓
┌─────────────────────────────────────────────────┐
│  Claude AI 处理                                  │
│  - 分析用户意图                                  │
│  - 调用工具 (Read, Edit, Bash)                  │
│  - 流式返回响应                                  │
└─────────────────────────────────────────────────┘
        ↓
[主进程] for await (message of q)
        ↓
[主进程] emit("stream.message", { message })
        ↓
[渲染进程] onServerEvent → handleServerEvent
        ↓
[渲染进程] useAppStore 更新状态
        ↓
[渲染进程] UI 重新渲染
```

### 删除操作检测流程

```
AI 调用 Bash 工具执行删除命令
        ↓
[主进程] runner.canUseTool(toolName, input)
        ↓
[主进程] checkIfDeletionOperation("Bash", { command: "rm ..." })
        ↓
检测到删除操作
        ↓
[主进程] emit("permission.request", { toolUseId, toolName, input })
        ↓
[渲染进程] 显示 DeletionConfirmDialog
        ↓
用户选择"允许"或"拒绝"
        ↓
[渲染进程] sendEvent("permission.response", { result })
        ↓
[主进程] resolve(PermissionResult)
        ↓
SDK 根据结果继续或中止
```

---

## 安全设计

### IPC 安全

**contextBridge 模式**：

```typescript
electron.contextBridge.exposeInMainWorld("electron", {
    // 仅暴露必要的 API
    sendClientEvent: (event) => { ... },
    onServerEvent: (callback) => { ... },
    // ...
});
```

**安全特性**：
- 渲染进程无法直接访问 Node.js API
- 所有通信通过预定义的 IPC 通道
- 主进程验证所有输入参数

### 删除操作保护

**双重检测机制**：

| 位置 | 检测方式 | 目的 |
|------|----------|------|
| 前端 | 正则表达式匹配 | 早期检测，UI 反馈 |
| 后端 | SDK canUseTool 回调 | 最终控制，阻止执行 |

**支持的删除命令**：

```typescript
// PowerShell
Remove-Item, Delete-Item, Remove-ItemProperty

// Windows CMD
del, erase, rmdir, rd

// Unix/Linux
rm, rmdir, unlink

// 其他工具
trash, shred, wipe, srm
```

### 敏感数据保护

**API 密钥存储**：

```
app.getPath("userData")/api-config.json
```

**安全措施**：
- 不提交到版本控制（.gitignore）
- 文件权限由操作系统控制
- 日志中自动脱敏（可扩展）

---

## 扩展性设计

### 状态管理 (Zustand)

**状态结构**：

```typescript
interface AppState {
  sessions: Record<string, SessionView>;
  activeSessionId: string | null;
  prompt: string;
  cwd: string;
  pendingStart: boolean;
  globalError: string | null;
  sessionsLoaded: boolean;
  showStartModal: boolean;
  showSettingsModal: boolean;
  historyRequested: Set<string>;
  apiConfigChecked: boolean;
}
```

**更新机制**：

```typescript
// 服务器事件驱动状态更新
handleServerEvent: (event: ServerEvent) => {
  switch (event.type) {
    case "session.status":
      // 更新会话状态
      set((state) => ({
        sessions: {
          ...state.sessions,
          [sessionId]: { ...existing, status }
        }
      }));
      break;
    // ...
  }
}
```

### 国际化 (i18next)

**支持的语言**：

- 中文 (zh)
- English (en)

**添加新语言**：

1. 在 `src/ui/i18n/locales/` 创建新文件
2. 复制 `en.ts` 的结构
3. 翻译所有字符串
4. 在 `i18n/config.ts` 中注册

### 插件化设计

**工具扩展**：

```typescript
// 可以添加新的工具检测规则
function checkIfDeletionOperation(toolName: string, input: unknown): boolean {
  // 自定义检测逻辑
  const customPatterns = [
    // 添加新的正则表达式
  ];
  // ...
}
```

---

## 性能优化

### 数据库优化

**WAL 模式**：

```typescript
this.db.exec(`pragma journal_mode = WAL;`);
```

**优势**：
- 并发读写性能提升
- 减少磁盘 I/O
- 更好的崩溃恢复

### 日志轮转

```typescript
new winston.transports.File({
    filename: path.join(logDir, 'app.log'),
    maxsize: 5242880, // 5MB
    maxFiles: 5
})
```

### 资源轮询优化

```typescript
const POLLING_INTERVAL = 2000; // 2秒
```

---

## 部署架构

### 打包流程

```
┌─────────────────────────────────────────────────────────┐
│  1. TypeScript 编译                                      │
│     tsc -b                                               │
│     ├─ dist-electron/  (主进程)                        │
│     └─ dist-react/     (前端)                          │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  2. Electron Builder 打包                               │
│     electron-builder --win --x64                        │
│     ├─ Agent Cowork 0.1.0.exe                          │
│     └─ resources/                                       │
│         ├─ app.asar.unpacked/                           │
│         │   └─ node_modules/                            │
│         │       ├─ @anthropic-ai/claude-agent-sdk/    │
│         │       └─ better-sqlite3/                     │
│         └─ app.asar                                     │
└─────────────────────────────────────────────────────────┘
```

### asarUnpack 列表

以下模块需要解包（原生模块）：

- `@anthropic-ai/claude-agent-sdk`
- `better-sqlite3`
- `os-utils`
- `winston`
- `winston-transport`

---

## 附录

### 环境变量

| 变量 | 说明 | 默认值 |
|------|------|--------|
| NODE_ENV | 环境模式 | development |
| PORT | Vite 开发服务器端口 | 5173 |
| DEBUG | 调试模式 | - |

### 配置文件

| 文件 | 用途 |
|------|------|
| `package.json` | 项目依赖和脚本 |
| `tsconfig.json` | TypeScript 配置入口 |
| `tsconfig.app.json` | 渲染进程 TS 配置 |
| `src/electron/tsconfig.json` | 主进程 TS 配置 |
| `vite.config.ts` | Vite 构建配置 |
| `electron-builder.json` | 打包配置 |
| `eslint.config.js` | ESLint 配置 |

---

**文档版本**: 1.0.0
**最后更新**: 2026-01-20
