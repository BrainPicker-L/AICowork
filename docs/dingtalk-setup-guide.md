# 钉钉机器人配置指南

## 常见问题：为什么机器人收不到消息？

这是配置钉钉机器人时最常遇到的问题，**绝大多数情况下不是代码问题，而是钉钉开发者后台的配置方式不对**。

### 根本原因

钉钉开发者后台有两种创建机器人的入口，**只有一种能正常工作**：

| 创建方式 | 位置 | 是否支持 Stream 模式 | 能否收到消息 |
|---------|------|-------------------|-----------|
| 企业内部应用 + 机器人能力 | 应用开发 → 企业内部开发 → 创建应用 → 添加机器人能力 | **支持** | **能** |
| 独立机器人 | 应用开发 → 机器人（与"企业内部开发"并列的入口） | 不支持 | **不能** |

AICowork 使用 `dingtalk-stream` SDK 通过 WebSocket 长连接接收消息，这要求机器人必须以**企业内部应用**的形式创建，并在应用内添加机器人能力。如果通过独立"机器人"入口创建，即使拿到了 AppKey 和 AppSecret，也无法建立 Stream 连接，表现为**连接成功但永远收不到消息**。

---

## 正确的配置步骤

### 第一步：创建企业内部应用

1. 登录 [钉钉开发者后台](https://open-dev.dingtalk.com/)
2. 进入 **应用开发** → **企业内部开发**
3. 点击 **创建应用**，填写应用名称（如"AICowork 助手"）和描述
4. 创建完成后进入应用详情页

### 第二步：添加机器人能力

1. 在应用详情页左侧菜单找到 **添加应用能力**（或 **应用功能** → **机器人**）
2. 添加 **机器人** 能力
3. 配置机器人信息：
   - **机器人名称**：用户在钉钉中看到的名字
   - **消息接收模式**：选择 **Stream 模式**（这是关键！）
   - 其他字段按需填写

### 第三步：获取凭证

在应用详情页的 **凭证与基础信息** 中获取：

- **Client ID (AppKey)**
- **Client Secret (AppSecret)**

这两个值需要填入 AICowork 设置页的钉钉机器人配置中。

### 第四步：配置权限

在应用详情页 **权限管理** 中，搜索并开通以下权限：

| 权限名称 | 权限代码 | 用途 |
|---------|---------|------|
| 企业内机器人发送消息 | `qyapi_robot_sendmsg` | 发送私聊/群聊回复 |
| 个人手机号信息 | `Contact.User.mobile` | 可选，用于用户识别 |

### 第五步：发布应用

1. 在应用详情页点击 **版本管理与发布**
2. 创建新版本并提交发布
3. 等待企业管理员审批通过（自建应用通常会自动通过）

### 第六步：在 AICowork 中配置

1. 打开 AICowork → 设置 → 钉钉机器人
2. 点击 **添加机器人**
3. 填写：
   - **机器人名称**：任意名称，用于在 AICowork 中识别
   - **Client ID**：第三步获取的 AppKey
   - **Client Secret**：第三步获取的 AppSecret
   - **启用机器人**：开启
4. 点击 **测试连接** 验证凭证是否正确
5. 保存配置后，点击 **连接**

---

## 故障排查

### 问题 1：连接显示成功，但收不到消息

**原因**：机器人不是通过"企业内部应用"创建的，或消息接收模式不是 Stream 模式。

**解决方案**：
1. 确认机器人在钉钉开发者后台的 **应用开发 → 企业内部开发** 列表中
2. 进入应用详情 → 机器人配置，确认消息接收模式为 **Stream 模式**
3. 确认应用已发布且审批通过

### 问题 2：能收到消息，但钉钉上收不到回复

**原因**：通常是权限不足或 API 调用参数问题。

**解决方案**：
1. 确认已开通 `qyapi_robot_sendmsg` 权限
2. 查看 AICowork 日志中是否有 `[dingtalk:xxx] Reply send failed` 相关错误
3. 如果日志显示 `400 Bad Request`，可能是 `senderStaffId` 映射问题（已在代码中修复）

### 问题 3：测试连接报错

**原因**：Client ID 或 Client Secret 填写错误。

**解决方案**：
1. 重新从钉钉开发者后台复制凭证（注意不要多复制空格）
2. 确认使用的是"凭证与基础信息"页面的 AppKey/AppSecret，不是其他 Key

### 问题 4：群聊中 @机器人 没有响应

**原因**：机器人可能还没有被添加到群中，或群聊策略设置为白名单但未包含该群。

**解决方案**：
1. 在钉钉群设置 → 智能群助手 中添加该机器人
2. 如果 AICowork 中群聊策略设置为"白名单"，确认已添加对应的群会话 ID

### 问题 5：应用重启后钉钉会话丢失

**说明**：这不是 bug。AICowork 会自动从数据库恢复钉钉会话映射，同一个 (用户, 机器人) 组合始终保持同一个会话。如果配置中启用了机器人，应用启动时会自动重新连接。

---

## 架构说明

```
钉钉用户发消息
    ↓
dingtalk-stream (WebSocket 长连接)
    ↓
DingTalkService.handleInboundMessage()
    ↓ 查找或创建 session
SessionStore (SQLite)
    ↓
runClaude() → AI 生成回复
    ↓
钉钉 OpenAPI (axios) → 发送回复给用户
```

- **消息接收**：通过 `dingtalk-stream` SDK 建立 WebSocket 长连接，实时接收消息推送
- **消息发送**：通过钉钉 OpenAPI（REST）发送回复，支持 Markdown 和 AI 互动卡片两种格式
- **会话管理**：每个 (用户, 机器人) 组合维持 1 个持久会话，支持跨重启恢复
- **多机器人**：支持同时配置和运行多个钉钉机器人，彼此独立互不影响
